{"ast":null,"code":"import _regeneratorRuntime from\"E:/SEM 4/MERN/end_sem_project/SocialEcho-main/client/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _asyncToGenerator from\"E:/SEM 4/MERN/end_sem_project/SocialEcho-main/client/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import jwt_decode from\"jwt-decode\";import{refreshTokenAction}from\"../redux/actions/refreshTokenAction\";export var tokenMiddleware=function tokenMiddleware(store){return function(next){return/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(action){var _state$auth,state,token,expiresIn,refreshToken,newToken;return _regeneratorRuntime().wrap(function _callee$(_context){while(1)switch(_context.prev=_context.next){case 0:if(!(action.meta&&action.meta.requiresAuth)){_context.next=21;break;}state=store.getState();token=(_state$auth=state.auth)===null||_state$auth===void 0?void 0:_state$auth.accessToken;if(!token){_context.next=20;break;}expiresIn=jwt_decode(token).exp*1000-Date.now();if(!(expiresIn<1800000)){_context.next=18;break;}refreshToken=state.auth.refreshToken;_context.prev=7;_context.next=10;return store.dispatch(refreshTokenAction(refreshToken));case 10:newToken=store.getState().auth.accessToken;if(newToken){_context.next=13;break;}throw new Error(\"Access token not found after refresh\");case 13:_context.next=18;break;case 15:_context.prev=15;_context.t0=_context[\"catch\"](7);store.dispatch({type:\"LOGOUT\"});case 18:_context.next=21;break;case 20:store.dispatch({type:\"LOGOUT\"});case 21:return _context.abrupt(\"return\",next(action));case 22:case\"end\":return _context.stop();}},_callee,null,[[7,15]]);}));return function(_x){return _ref.apply(this,arguments);};}();};};","map":{"version":3,"names":["jwt_decode","refreshTokenAction","tokenMiddleware","store","next","_ref","_asyncToGenerator","_regeneratorRuntime","mark","_callee","action","_state$auth","state","token","expiresIn","refreshToken","newToken","wrap","_callee$","_context","prev","meta","requiresAuth","getState","auth","accessToken","exp","Date","now","dispatch","Error","t0","type","abrupt","stop","_x","apply","arguments"],"sources":["E:/SEM 4/MERN/end_sem_project/SocialEcho-main/client/src/middlewares/tokenMiddleware.js"],"sourcesContent":["import jwt_decode from \"jwt-decode\";\nimport { refreshTokenAction } from \"../redux/actions/refreshTokenAction\";\n\nexport const tokenMiddleware = (store) => (next) => async (action) => {\n  if (action.meta && action.meta.requiresAuth) {\n    const state = store.getState();\n    const token = state.auth?.accessToken;\n    if (token) {\n      const expiresIn = jwt_decode(token).exp * 1000 - Date.now();\n      if (expiresIn < 1800000) {\n        const refreshToken = state.auth.refreshToken;\n        try {\n          await store.dispatch(refreshTokenAction(refreshToken));\n          const newToken = store.getState().auth.accessToken;\n          if (!newToken) {\n            throw new Error(\"Access token not found after refresh\");\n          }\n        } catch (error) {\n          store.dispatch({ type: \"LOGOUT\" });\n        }\n      }\n    } else {\n      store.dispatch({ type: \"LOGOUT\" });\n    }\n  }\n  return next(action);\n};\n"],"mappings":"oSAAA,MAAO,CAAAA,UAAU,KAAM,YAAY,CACnC,OAASC,kBAAkB,KAAQ,qCAAqC,CAExE,MAAO,IAAM,CAAAC,eAAe,CAAG,QAAlB,CAAAA,eAAeA,CAAIC,KAAK,QAAK,UAACC,IAAI,oCAAAC,IAAA,CAAAC,iBAAA,cAAAC,mBAAA,GAAAC,IAAA,CAAK,SAAAC,QAAOC,MAAM,MAAAC,WAAA,CAAAC,KAAA,CAAAC,KAAA,CAAAC,SAAA,CAAAC,YAAA,CAAAC,QAAA,QAAAT,mBAAA,GAAAU,IAAA,UAAAC,SAAAC,QAAA,iBAAAA,QAAA,CAAAC,IAAA,CAAAD,QAAA,CAAAf,IAAA,cAC3DM,MAAM,CAACW,IAAI,EAAIX,MAAM,CAACW,IAAI,CAACC,YAAY,GAAAH,QAAA,CAAAf,IAAA,WACnCQ,KAAK,CAAGT,KAAK,CAACoB,QAAQ,CAAC,CAAC,CACxBV,KAAK,EAAAF,WAAA,CAAGC,KAAK,CAACY,IAAI,UAAAb,WAAA,iBAAVA,WAAA,CAAYc,WAAW,KACjCZ,KAAK,EAAAM,QAAA,CAAAf,IAAA,WACDU,SAAS,CAAGd,UAAU,CAACa,KAAK,CAAC,CAACa,GAAG,CAAG,IAAI,CAAGC,IAAI,CAACC,GAAG,CAAC,CAAC,MACvDd,SAAS,CAAG,OAAO,GAAAK,QAAA,CAAAf,IAAA,WACfW,YAAY,CAAGH,KAAK,CAACY,IAAI,CAACT,YAAY,CAAAI,QAAA,CAAAC,IAAA,GAAAD,QAAA,CAAAf,IAAA,UAEpC,CAAAD,KAAK,CAAC0B,QAAQ,CAAC5B,kBAAkB,CAACc,YAAY,CAAC,CAAC,SAChDC,QAAQ,CAAGb,KAAK,CAACoB,QAAQ,CAAC,CAAC,CAACC,IAAI,CAACC,WAAW,IAC7CT,QAAQ,EAAAG,QAAA,CAAAf,IAAA,gBACL,IAAI,CAAA0B,KAAK,CAAC,sCAAsC,CAAC,SAAAX,QAAA,CAAAf,IAAA,kBAAAe,QAAA,CAAAC,IAAA,IAAAD,QAAA,CAAAY,EAAA,CAAAZ,QAAA,aAGzDhB,KAAK,CAAC0B,QAAQ,CAAC,CAAEG,IAAI,CAAE,QAAS,CAAC,CAAC,CAAC,QAAAb,QAAA,CAAAf,IAAA,kBAIvCD,KAAK,CAAC0B,QAAQ,CAAC,CAAEG,IAAI,CAAE,QAAS,CAAC,CAAC,CAAC,eAAAb,QAAA,CAAAc,MAAA,UAGhC7B,IAAI,CAACM,MAAM,CAAC,2BAAAS,QAAA,CAAAe,IAAA,MAAAzB,OAAA,iBACpB,mBAAA0B,EAAA,SAAA9B,IAAA,CAAA+B,KAAA,MAAAC,SAAA"},"metadata":{},"sourceType":"module","externalDependencies":[]}